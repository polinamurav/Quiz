(()=>{"use strict";class e{constructor(){this.agreeElement=null,this.processElement=null,this.fields=[{name:"name",id:"name",element:null,regex:/^[А-Я][а-я]+\s*$/,valid:!1},{name:"lastName",id:"last-name",element:null,regex:/^[А-Я][а-я]+\s*$/,valid:!1},{name:"email",id:"email",element:null,regex:/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/,valid:!1}];const e=this;localStorage.removeItem("userAnswers"),localStorage.removeItem("testId"),localStorage.removeItem("userName"),localStorage.removeItem("score"),localStorage.removeItem("total"),this.fields.forEach((t=>{t.element=document.getElementById(t.id),t.element.onchange=function(){e.validateField.call(e,t,this)}})),this.processElement=document.getElementById("process"),this.processElement.onclick=function(){e.processForm()},this.agreeElement=document.getElementById("agree"),this.agreeElement.onchange=function(){e.validateForm()}}validateField(e,t){t.value&&t.value.match(e.regex)?(t.parentNode.removeAttribute("style"),e.valid=!0):(t.parentNode.style.borderColor="red",e.valid=!1),this.validateForm()}validateForm(){const e=this.fields.every((e=>e.valid)),t=this.agreeElement.checked&&e;return t?this.processElement.removeAttribute("disabled"):this.processElement.setAttribute("disabled","disabled"),t}processForm(){if(this.validateForm()){let e="";this.fields.forEach((t=>{e+=(e?"&":"?")+t.name+"="+t.element.value})),location.href="#/choice"+e}}}class t{static getQueryParams(){const e=document.location.hash.split("+").join(" ");let t,s={},n=/[?&]([^=]+)=([^&]*)/g;for(;t=n.exec(e);)s[decodeURIComponent(t[1])]=decodeURIComponent(t[2]);return s}static checkUserData(e){e.name&&e.lastName&&e.email||(location.href="index.html")}}class s{constructor(){this.quizzes=[],this.routeParams=t.getQueryParams(),t.checkUserData(this.routeParams);const e=new XMLHttpRequest;if(e.open("GET","https://testologia.ru/get-quizzes",!1),e.send(),200===e.status&&e.responseText){try{this.quizzes=JSON.parse(e.responseText)}catch(e){location.href="#/"}this.processQuizzes()}else location.href="#/"}processQuizzes(){const e=document.getElementById("choice-options");this.quizzes&&this.quizzes.length>0&&this.quizzes.forEach((t=>{const s=this,n=document.createElement("div");n.className="choice-option",n.setAttribute("data-id",t.id),n.onclick=function(){s.chooseQuiz(this)};const i=document.createElement("div");i.className="choice-option-text",i.innerText=t.name;const o=document.createElement("div");o.className="choice-option-arrow";const r=document.createElement("img");r.setAttribute("src","/images/arrow.png"),r.setAttribute("alt","Стрелка"),o.appendChild(r),n.appendChild(i),n.appendChild(o),e.appendChild(n)}))}chooseQuiz(e){const t=e.getAttribute("data-id");t&&(location.href="#/test?name="+this.routeParams.name+"&lastName="+this.routeParams.lastName+"&email="+this.routeParams.email+location.search+"&id="+t)}}class n{constructor(){if(this.progressBarElement=null,this.questionTitleElement=null,this.optionsElement=null,this.nextButtonElement=null,this.prevButtonElement=null,this.passButtonElement=null,this.quiz=null,this.currentQuestionIndex=1,this.userResult=[],this.routeParams=t.getQueryParams(),t.checkUserData(this.routeParams),this.routeParams.id){const e=new XMLHttpRequest;if(e.open("GET","https://testologia.ru/get-quiz?id="+this.routeParams.id,!1),e.send(),200===e.status&&e.responseText){try{this.quiz=JSON.parse(e.responseText)}catch(e){location.href="#/"}this.startQuiz()}else location.href="#/"}else location.href="#/"}startQuiz(){this.progressBarElement=document.getElementById("progress-bar"),this.questionTitleElement=document.getElementById("title"),this.optionsElement=document.getElementById("options"),this.nextButtonElement=document.getElementById("next"),this.nextButtonElement.onclick=this.move.bind(this,"next"),this.passButtonElement=document.getElementById("pass"),this.passButtonElement.onclick=this.move.bind(this,"pass"),this.prevButtonElement=document.getElementById("prev"),this.prevButtonElement.onclick=this.move.bind(this,"prev"),document.getElementById("pre-title").innerText=this.quiz.name,this.prepareProgressBar(),this.showQuestion();const e=document.getElementById("timer");let t=59;const s=setInterval(function(){t--,e.innerText=t,0===t&&(clearInterval(s),this.complete())}.bind(this),1e3)}prepareProgressBar(){for(let e=0;e<this.quiz.questions.length;e++){const t=document.createElement("div");t.className="test-progress-bar-item "+(0===e?"active":"");const s=document.createElement("div");s.className="test-progress-bar-item-circle";const n=document.createElement("div");n.className="test-progress-bar-item-text",n.innerText="Вопрос: "+(e+1),t.appendChild(s),t.appendChild(n),this.progressBarElement.appendChild(t)}}showQuestion(){const e=this.quiz.questions[this.currentQuestionIndex-1];this.questionTitleElement.innerHTML="<span>Вопрос "+this.currentQuestionIndex+":</span> "+e.question,this.optionsElement.innerHTML="";const t=this,s=this.userResult.find((t=>t.questionId===e.id));e.answers.forEach((e=>{const n=document.createElement("div");n.className="test-question-option";const i="answer-"+e.id,o=document.createElement("input");o.className="option-answer",o.setAttribute("id",i),o.setAttribute("type","radio"),o.setAttribute("name","answer"),o.setAttribute("value",e.id),s&&s.chosenAnswerId===e.id&&o.setAttribute("checked","checked"),this.passButtonElement.classList.remove("disabled-link"),o.onchange=function(){t.chooseAnswer()};const r=document.createElement("label");r.setAttribute("for",i),r.innerText=e.answer,n.appendChild(o),n.appendChild(r),this.optionsElement.appendChild(n)})),s&&s.chosenAnswerId?this.nextButtonElement.removeAttribute("disabled"):this.nextButtonElement.setAttribute("disabled","disabled"),this.currentQuestionIndex===this.quiz.questions.length?this.nextButtonElement.innerText="Завершить":this.nextButtonElement.innerText="Далее",this.currentQuestionIndex>1?this.prevButtonElement.removeAttribute("disabled"):this.prevButtonElement.setAttribute("disabled","disabled")}chooseAnswer(){this.nextButtonElement.removeAttribute("disabled"),this.passButtonElement.classList.add("disabled-link")}move(e){const t=this.quiz.questions[this.currentQuestionIndex-1],s=Array.from(document.getElementsByClassName("option-answer")).find((e=>e.checked));let n=null;s&&s.value&&(n=Number(s.value));const i=this.userResult.find((e=>e.questionId===t.id));i?i.chosenAnswerId=n:this.userResult.push({questionId:t.id,chosenAnswerId:n}),"next"===e||"pass"===e?this.currentQuestionIndex++:this.currentQuestionIndex--,this.currentQuestionIndex>this.quiz.questions.length?this.complete():(Array.from(this.progressBarElement.children).forEach(((e,t)=>{const s=t+1;e.classList.remove("complete"),e.classList.remove("active"),s===this.currentQuestionIndex?e.classList.add("active"):s<this.currentQuestionIndex&&e.classList.add("complete")})),this.showQuestion())}complete(){const e=new XMLHttpRequest;if(e.open("POST","https://testologia.ru/pass-quiz?id="+this.routeParams.id,!1),e.setRequestHeader("Content-Type","application/json;charset=UTF-8"),e.send(JSON.stringify({name:this.routeParams.name,lastName:this.routeParams.lastName,email:this.routeParams.email,results:this.userResult})),200===e.status&&e.responseText){let t=null;try{t=JSON.parse(e.responseText)}catch(e){location.href="#/"}t&&(localStorage.setItem("testId",this.routeParams.id),localStorage.setItem("userAnswers",JSON.stringify(this.userResult)),localStorage.setItem("userName",JSON.stringify(this.routeParams.name+" "+this.routeParams.lastName+", "+this.routeParams.email)),localStorage.setItem("score",t.score),localStorage.setItem("total",t.total),location.href="#/result?score="+t.score+"&total="+t.total)}else location.href="#/"}}class i{constructor(){let e=this;this.routeParams=t.getQueryParams();const s=localStorage.getItem("testId"),n=this.routeParams.score,i=this.routeParams.total;document.getElementById("result-score").innerText=n+"/"+i,document.getElementById("see-result").onclick=function(){e.seeResult(s)}}seeResult(e){e&&(location.href="answers.html?id="+e)}}class o{constructor(){this.answer=null,this.quiz=null,this.optionsElement=null,this.userAnswers=null;const e=new URL(location.href).searchParams.get("id");if(e){const t=new XMLHttpRequest;if(t.open("GET","https://testologia.ru/get-quiz-right?id="+e,!1),t.send(),200===t.status&&t.responseText){try{this.answer=JSON.parse(t.responseText),console.log(this.answer)}catch(e){location.href="#/"}this.checkAnswer()}else location.href="#/"}else location.href="#/"}checkAnswer(){const e=new URL(location.href).searchParams.get("id");if(e){const t=new XMLHttpRequest;if(t.open("GET","https://testologia.ru/get-quiz?id="+e,!1),t.send(),200===t.status&&t.responseText){try{this.quiz=JSON.parse(t.responseText),console.log(this.quiz)}catch(e){location.href="#/"}this.displayAnswer()}else location.href="#/"}else location.href="#/"}displayAnswer(){let e=this;this.userAnswers=JSON.parse(localStorage.getItem("userAnswers")),console.log(this.userAnswers),document.getElementById("my-result").addEventListener("click",(function(){e.complete()})),this.optionsElement=document.getElementById("options"),this.optionsElement.innerHTML="",document.getElementById("answer-pre-title").innerText=this.quiz.name;const t=JSON.parse(localStorage.getItem("userName"));document.getElementById("answers-title-name").innerText=t,this.quiz.questions.forEach(((e,t)=>{const s=document.createElement("div");s.className="answers-question";const n=document.createElement("div");n.className="answers-question-title common-question-title",n.innerHTML="<span>Вопрос "+(t+1)+":</span> "+e.question;const i=document.createElement("div");i.className="answers-question-options";const o=this.userAnswers.find((t=>t.questionId===e.id));e.answers.forEach((e=>{const t=document.createElement("div");t.className="answers-question-option";const s=document.createElement("input");s.setAttribute("id","answer-"+e.id),s.setAttribute("type","radio"),s.setAttribute("name","answer"),s.setAttribute("disabled","disabled"),o&&o.chosenAnswerId===e.id&&(s.checked=!0,this.answer.includes(e.id)?(t.classList.add("correct"),s.classList.add("correct")):(t.classList.add("incorrect"),s.classList.add("incorrect")));const n=document.createElement("label");n.setAttribute("for","answer-"+e.id),n.innerText=e.answer,t.appendChild(s),t.appendChild(n),i.appendChild(t)})),s.appendChild(n),s.appendChild(i),this.optionsElement.appendChild(s)}))}complete(){let e=localStorage.getItem("score"),t=localStorage.getItem("total");location.href="result.html?score="+e+"&total="+t}}class r{constructor(){this.routes=[{route:"#/",title:"Главная",template:"templates/index.html",styles:"styles/index.css",load:()=>{}},{route:"#/form",title:"Регистрация",template:"templates/form.html",styles:"styles/form.css",load:()=>{new e}},{route:"#/choice",title:"Выбор теста",template:"templates/choice.html",styles:"styles/choice.css",load:()=>{new s}},{route:"#/test",title:"Прохождение теста",template:"templates/test.html",styles:"styles/test.css",load:()=>{new n}},{route:"#/result",title:"Результаты",template:"templates/result.html",styles:"styles/result.css",load:()=>{new i}},{route:"#/answers",title:"Ответы",template:"templates/answers.html",styles:"styles/answers.css",load:()=>{new o}}]}async openRoute(){const e=this.routes.find((e=>e.route===window.location.hash.split("?")[0]));e?(document.getElementById("content").innerHTML=await fetch(e.template).then((e=>e.text())),document.getElementById("styles").setAttribute("href",e.styles),document.getElementById("title").innerText=e.title,e.load()):window.location.href="#/"}}new class{constructor(){this.router=new r,window.addEventListener("DOMContentLoaded",this.handleRouteChanging.bind(this)),window.addEventListener("popstate",this.handleRouteChanging.bind(this))}handleRouteChanging(){this.router.openRoute()}}})();